#!/usr/bin/env node
var BuildPackage=function(t){var n=function(){function t(t,n){this.flags=t,this.required=~t.indexOf("<"),this.optional=~t.indexOf("["),this.bool=!~t.indexOf("-no-"),t=t.split(/[ ,|]+/),t.length>1&&!/^[[<]/.test(t[1])&&(this.short=t.shift()),this.long=t.shift(),this.description=n||""}function n(t){this.commands=[],this.options=[],this._args=[],this._name=t}function e(t){return t.split("-").reduce(function(t,n){return t+n[0].toUpperCase()+n.slice(1)})}function o(t){return/^y|yes|ok|true$/i.test(t)}function i(t,n){var e=Math.max(0,n-t.length);return t+Array(e+1).join(" ")}function r(t,n){n=n||[];for(var e=0;e<n.length;e++)("--help"==n[e]||"-h"==n[e])&&(t.outputHelp(),process.exit(0))}var s=require("events").EventEmitter,u=require("child_process").spawn,p=require("fs"),l=p.existsSync,a=require("path"),c=a.dirname,h=a.basename;return t.prototype.name=function(){return this.long.replace("--","").replace("no-","")},t.prototype.is=function(t){return t==this.short||t==this.long},n.prototype.__proto__=s.prototype,n.prototype.command=function(t,e){var o=t.split(/ +/),i=new n(o.shift());return e&&i.description(e),e&&(this.executables=!0),this.commands.push(i),i.parseExpectedArgs(o),i.parent=this,e?this:i},n.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")},n.prototype.parseExpectedArgs=function(t){if(t.length){var n=this;return t.forEach(function(t){switch(t[0]){case"<":n._args.push({required:!0,name:t.slice(1,-1)});break;case"[":n._args.push({required:!1,name:t.slice(1,-1)})}}),this}},n.prototype.action=function(t){var n=this;return this.parent.on(this._name,function(e,o){o=o||[];var i=n.parseOptions(o);r(n,i.unknown),i.unknown.length>0&&n.unknownOption(i.unknown[0]),i.args.length&&(e=i.args.concat(e)),n._args.forEach(function(t,o){t.required&&null==e[o]&&n.missingArgument(t.name)}),n._args.length?e[n._args.length]=n:e.push(n),t.apply(this,e)}),this},n.prototype.option=function(n,o,i,r){var s=this,u=new t(n,o),p=u.name(),l=e(p);return"function"!=typeof i&&(r=i,i=null),(0==u.bool||u.optional||u.required)&&(0==u.bool&&(r=!0),void 0!==r&&(s[l]=r)),this.options.push(u),this.on(p,function(t){null!=t&&i&&(t=i(t)),"boolean"==typeof s[l]||"undefined"==typeof s[l]?s[l]=null==t?u.bool?r||!0:!1:t:null!==t&&(s[l]=t)}),this},n.prototype.parse=function(t){this.executables&&this.addImplicitHelpCommand(),this.rawArgs=t,this._name=this._name||h(t[1]);var n=this.parseOptions(this.normalize(t.slice(2))),e=this.args=n.args;return this.executables?this.executeSubCommand(t,e,n.unknown):this.parseArgs(this.args,n.unknown)},n.prototype.executeSubCommand=function(t,n,e){n=n.concat(e),n.length||this.help(),"help"==n[0]&&1==n.length&&this.help(),"help"==n[0]&&(n[0]=n[1],n[1]="--help");var o=c(t[1]),i=h(t[1])+"-"+n[0],r=a.join(o,i);l(r)&&(i=r),n=n.slice(1);var s=u(i,n,{stdio:"inherit",customFds:[0,1,2]});s.on("exit",function(t){127==t&&console.error("\n  %s(1) does not exist\n",i)})},n.prototype.normalize=function(t){for(var n,e,o=[],i=0,r=t.length;r>i;++i)n=t[i],n.length>1&&"-"==n[0]&&"-"!=n[1]?n.slice(1).split("").forEach(function(t){o.push("-"+t)}):/^--/.test(n)&&~(e=n.indexOf("="))?o.push(n.slice(0,e),n.slice(e+1)):o.push(n);return o},n.prototype.parseArgs=function(t,n){var e,o=this.commands;return o.length,t.length?(e=t[0],this.listeners(e).length?this.emit(t.shift(),t,n):this.emit("*",t)):(r(this,n),n.length>0&&this.unknownOption(n[0])),this},n.prototype.optionFor=function(t){for(var n=0,e=this.options.length;e>n;++n)if(this.options[n].is(t))return this.options[n]},n.prototype.parseOptions=function(t){for(var n,e,o,i=[],r=t.length,s=[],u=0;r>u;++u)if(o=t[u],"--"!=o)if(n)i.push(o);else if(e=this.optionFor(o))if(e.required){if(o=t[++u],null==o)return this.optionMissingArgument(e);if("-"==o[0])return this.optionMissingArgument(e,o);this.emit(e.name(),o)}else e.optional?(o=t[u+1],null==o||"-"==o[0]?o=null:++u,this.emit(e.name(),o)):this.emit(e.name());else o.length>1&&"-"==o[0]?(s.push(o),t[u+1]&&"-"!=t[u+1][0]&&s.push(t[++u])):i.push(o);else n=!0;return{args:i,unknown:s}},n.prototype.missingArgument=function(t){console.error(),console.error("  error: missing required argument `%s'",t),console.error(),process.exit(1)},n.prototype.optionMissingArgument=function(t,n){console.error(),n?console.error("  error: option `%s' argument missing, got `%s'",t.flags,n):console.error("  error: option `%s' argument missing",t.flags),console.error(),process.exit(1)},n.prototype.unknownOption=function(t){console.error(),console.error("  error: unknown option `%s'",t),console.error(),process.exit(1)},n.prototype.version=function(t,n){return 0==arguments.length?this._version:(this._version=t,n=n||"-V, --version",this.option(n,"output the version number"),this.on("version",function(){console.log(t),process.exit(0)}),this)},n.prototype.description=function(t){return 0==arguments.length?this._description:(this._description=t,this)},n.prototype.usage=function(t){var n=this._args.map(function(t){return t.required?"<"+t.name+">":"["+t.name+"]"}),e="[options"+(this.commands.length?"] [command":"")+"]"+(this._args.length?" "+n:"");return 0==arguments.length?this._usage||e:(this._usage=t,this)},n.prototype.largestOptionLength=function(){return this.options.reduce(function(t,n){return Math.max(t,n.flags.length)},0)},n.prototype.optionHelp=function(){var t=this.largestOptionLength();return[i("-h, --help",t)+"  "+"output usage information"].concat(this.options.map(function(n){return i(n.flags,t)+"  "+n.description})).join("\n")},n.prototype.commandHelp=function(){return this.commands.length?["","  Commands:","",this.commands.map(function(t){var n=t._args.map(function(t){return t.required?"<"+t.name+">":"["+t.name+"]"}).join(" ");return i(t._name+(t.options.length?" [options]":"")+" "+n,22)+(t.description()?" "+t.description():"")}).join("\n").replace(/^/gm,"    "),""].join("\n"):""},n.prototype.helpInformation=function(){return["","  Usage: "+this._name+" "+this.usage(),""+this.commandHelp(),"  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""].join("\n")},n.prototype.promptForNumber=function(t,n){var e=this;this.promptSingleLine(t,function o(i){return i=Number(i),isNaN(i)?e.promptSingleLine(t+"(must be a number) ",o):(n(i),void 0)})},n.prototype.promptForDate=function(t,n){var e=this;this.promptSingleLine(t,function o(i){return i=new Date(i),isNaN(i.getTime())?e.promptSingleLine(t+"(must be a date) ",o):(n(i),void 0)})},n.prototype.promptSingleLine=function(t,n){return"function"==typeof arguments[2]?this["promptFor"+(n.name||n)](t,arguments[2]):(process.stdout.write(t),process.stdin.setEncoding("utf8"),process.stdin.once("data",function(t){n(t.trim())}).resume(),void 0)},n.prototype.promptMultiLine=function(t,n){var e=[];console.log(t),process.stdin.setEncoding("utf8"),process.stdin.on("data",function(t){"\n"==t||"\r\n"==t?(process.stdin.removeAllListeners("data"),n(e.join("\n"))):e.push(t.trimRight())}).resume()},n.prototype.prompt=function(t,n){function e(){var s=i.shift(),u=t[s];return s?(o.prompt(u,function(t){r[s]=t,e()}),void 0):n(r)}var o=this;if("string"==typeof t){if(/ $/.test(t))return this.promptSingleLine.apply(this,arguments);this.promptMultiLine(t,n)}else{var i=Object.keys(t),r={};e()}},n.prototype.password=function(){},n.prototype.confirm=function(t,n,e){var i=this;this.prompt(t,function(r){return r.trim()?(n(o(r)),void 0):(e||(t+="(yes or no) "),i.confirm(t,n,!0))})},n.prototype.choose=function(t,n,e){function o(){i.prompt("  : ",function(i){i=parseInt(i,10)-1,r&&isNaN(i)&&(i=n),null==t[i]?o():e(i,t[i])})}var i=this,r="number"==typeof n;r||(e=n,n=null),t.forEach(function(t,e){r&&e==n?console.log("* %d) %s",e+1,t):console.log("  %d) %s",e+1,t)}),o()},n.prototype.outputHelp=function(){process.stdout.write(this.helpInformation()),this.emit("--help")},n.prototype.help=function(){this.outputHelp(),process.exit()},new n}.call(this),e=require("fs"),o=require("path"),i=require("child_process").exec,r=e.realpathSync,s=e.readFileSync,u=e.writeFileSync,p=e.existsSync,l=e.unlinkSync,a=o.dirname,c=o.join,h=process.exit,f=console.log,m=console.error,g=require("temp"),d=n,y=r(__dirname),v=Object.prototype.hasOwnProperty,E="utf8",S=function(t,n){return 0===t.indexOf(n)},_=function(n,e){n=n||{};for(var o in n)v.call(e,o)&&v.call(n,o)&&t!==e[o]&&(n[o]=e[o]);return n},C=function(){return g.path({suffix:".tmpnode"})},x=function(t){return s(t,{encoding:E}).toString()},F=function(t,n){return u(t,n.toString(),{encoding:E})},O=function(t){p(t)&&l(t)},b={depsFile:"",realpath:"",inFiles:null,doMinify:!1,useClosure:!1,optsUglify:"",optsClosure:"",outFile:null,outputToStdOut:!0,_init_:function(){b.depsFile="",b.realpath="",E="utf8",b.inFiles=null,b.doMinify=!1,b.useClosure=!1,b.optsUglify="",b.optsClosure="",b.outFile=null,b.outputToStdOut=!0},pathreal:function(t){return""!=b.realpath&&(S(t,"./")||S(t,"../")||S(t,".\\")||S(t,"..\\"))?c(b.realpath,t):t},parseArgs:function(){return d.option("--deps [DEPEMDENCIES_FILE]","DEPEMDENCIES_FILE").option("--closure","Use Java Closure, else UglifyJS Compiler (default)",!1).option("--enc [ENCODING]","set text encoding","utf8").on("--help",function(){f("build.js --deps DEPENDENCIES_FILE [--closure --enc ENCODING]"),f("\n"),f("Build and Compress Javascript Packages"),f("\n"),f("deps (String, REQUIRED): DEPENDENCIES_FILE"),f("closure (Boolean, Optional): Use Java Closure, else UglifyJS Compiler (default)"),f("enc (String, Optional): set text encoding (default utf8)"),f("\n")}).parse(process.argv),_({deps:!1,closure:!1,enc:"utf8"},d)},parseSettings:function(){var t,n,e=[],o=[],i=[],r=[],s=!1,u=!1,p=!1,l=x(b.depsFile).split(/\n\r|\r\n|\r|\n/),a=l.length;for(t=0;a>t;t++)if(n=l[t].replace(/^\s+/,"").replace(/\s+$/,""),!S(n,"#")&&""!=n)if(S(n,"@")){if(S(n,"@DEPENDENCIES")){s=e,p=!1;continue}if(S(n,"@MINIFY")){s=!1,u=!0,p=!0;continue}if(p&&S(n,"@UGLIFY")){s=i;continue}if(p&&S(n,"@CLOSURE")){s=r;continue}if(S(n,"@OUT")){s=o,p=!1;continue}s=!1,p=!1}else s&&s.push(n);o[0]?(b.outFile=b.pathreal(o[0]),b.outputToStdOut=!1):(b.outFile=null,b.outputToStdOut=!0),b.inFiles=e,b.doMinify=u,b.optsUglify=i.join(" "),b.optsClosure=r.join(" ")},parse:function(){var t=b.parseArgs(),n=b.depsFile=r(t.deps);b.realpath=a(n),E=t.enc,b.useClosure=t.closure,b.parseSettings()},mergeFiles:function(){var t,n,e=b.inFiles,o=e.length,i=[];if(e&&o){for(t=0;o>t;t++)n=b.pathreal(e[t]),i.push(x(n));return i.join("")}return""},extractHeader:function(t){var n="";return S(t,"/**")&&(n=t.substr(0,t.indexOf("**/")+3)),n},compress:function(t,n){if(""!=t){var e,o=C(),r=C();F(o,t),e=b.useClosure?"java -jar "+c(y,"compiler/compiler.jar")+" "+b.optsClosure+" --js "+o+" --js_output_file "+r:"uglifyjs "+o+" "+b.optsUglify+" -o "+r,i(e,null,function(t,e,i){if(t)O(o),O(r),n&&n(null,t,e,i);else{var s=x(r);O(o),O(r),n&&n(s,t,e,i)}})}else n&&n("",null,"","")},build:function(){var t=b.mergeFiles(),n="",e=new Array(65).join("=");b.doMinify?(b.outputToStdOut||(f(e),f("Compiling and Minifying "+(b.useClosure?"(Java Closure Compiler)":"(Node UglifyJS Compiler)")+" "+b.outFile),f(e)),n=b.extractHeader(t),b.compress(t,function(t,e,o,i){t?(b.outputToStdOut?f(n+t):F(b.outFile,n+t),i&&m(i),h(0)):(i&&m(i),h(1))})):(b.outputToStdOut||(f(e),f("Compiling "+b.outFile),f(e)),b.outputToStdOut?f(n+t):F(b.outFile,n+t))}};return b}.call(this);BuildPackage.parse(),BuildPackage.build();